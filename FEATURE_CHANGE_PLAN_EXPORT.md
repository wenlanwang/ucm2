# 导出变更方案功能文档

## 功能概述

导出变更方案功能用于将指定日期的所有需求数据（导入、修改、删除三种类型）按照地点（外高桥、嘉定、境外机构、分行）进行分组，生成变更方案和回退方案两种Excel文件，并打包为ZIP文件下载。

## 功能位置

- **页面**：需求列表页
- **按钮**：导出变更方案（位于"导出需求"按钮右侧）

## 功能特性

### 1. 数据分组

系统将选中日期的所有需求数据按以下维度分组：
- **需求类型**：导入、修改、删除
- **部署地点**：外高桥、嘉定、境外机构、分行

### 2. 地点识别规则

#### 优先级1：根据IP前缀判断
- `76.` 开头 → 嘉定
- `84.` 开头 → 外高桥
- `123.` 开头 → 境外机构

#### 优先级2：根据名称/老指标前2位判断
- `NF` 开头 → 外高桥
- `JD` 开头 → 嘉定
- 其他字母开头 → 分行
- 非字母开头 → 分行

#### 列名差异
- **导入/删除类型**：使用 `IP` 列、`名称` 列
- **修改类型**：使用 `设备ip` 列、`老指标` 列

### 3. 文件生成规则

#### 变更方案

| 类型 | 模板 | 字段映射规则 |
|------|------|------------|
| 删除 | 删除模板 | 设备IP→IP, 需求→'删除', 老指标→名称, 新指标→空 |
| 修改 | 修改模板 | 列名与需求列表一一对应 |
| 导入 | 导入模板 | 列名与需求列表一一对应 |

#### 回退方案

| 类型 | 模板 | 字段映射规则 |
|------|------|------------|
| 删除 | 导入模板 | 列名与需求列表一一对应 |
| 修改 | 修改模板 | 设备ip→设备ip, 修改指标→修改指标, 老指标→新指标, 新指标→老指标 |
| 导入 | 导入模板 | 设备IP→IP, 需求→'删除', 老指标→名称, 新指标→空 |

### 4. 文件命名规范

#### 变更方案
- `UCM_导入_外高桥.xls`
- `UCM_导入_嘉定.xls`
- `UCM_导入_分行.xls`
- `UCM_导入_境外机构.xls`
- `UCM_修改_外高桥.xls`
- `UCM_修改_嘉定.xls`
- `UCM_修改_分行.xls`
- `UCM_修改_境外机构.xls`
- `UCM_删除_外高桥.xls`
- `UCM_删除_嘉定.xls`
- `UCM_删除_分行.xls`
- `UCM_删除_境外机构.xls`

#### 回退方案
- `UCM_导入_外高桥_回退.xls`
- `UCM_导入_嘉定_回退.xls`
- `UCM_导入_分行_回退.xls`
- `UCM_导入_境外机构_回退.xls`
- `UCM_修改_外高桥_回退.xls`
- `UCM_修改_嘉定_回退.xls`
- `UCM_修改_分行_回退.xls`
- `UCM_修改_境外机构_回退.xls`
- `UCM_删除_外高桥_回退.xls`
- `UCM_删除_嘉定_回退.xls`
- `UCM_删除_分行_回退.xls`
- `UCM_删除_境外机构_回退.xls`

#### 压缩包
- 文件名：`UCM变更方案_2026-01-31.zip`
- 格式：ZIP

### 5. 重要规则

- 如果某类数据为空，则不生成对应的文件
- 变更方案和回退方案一一对应（有则有，无则无）
- Excel文件格式：`.xls`（Excel 97-2003）
- 表头样式：与下载模板保持一致（带颜色和边框）

## 技术实现

### 后端实现

#### API端点
```
POST /api/requirements/export_change_plan/
```

#### 请求参数
```json
{
  "ucm_change_date": "2026-01-31"
}
```

#### 响应
- 成功：返回ZIP文件（二进制流）
- 失败：返回错误信息

#### 核心函数

1. **export_change_plan** - 主入口函数
   - 查询选中日期的所有需求数据
   - 按类型和地点分组
   - 生成变更方案和回退方案
   - 打包为ZIP文件返回

2. **_group_by_type_and_location** - 数据分组函数
   - 按需求类型（import/modify/delete）分组
   - 按地点（外高桥/嘉定/境外机构/分行）分组

3. **_get_location** - 地点识别函数
   - 根据IP前缀判断地点
   - 根据名称/老指标前2位判断地点

4. **_generate_change_plans** - 生成变更方案
   - 遍历所有类型和地点组合
   - 为每组数据生成对应的变更方案文件

5. **_generate_rollback_plans** - 生成回退方案
   - 遍历所有类型和地点组合
   - 为每组数据生成对应的回退方案文件

6. **_generate_delete_change_plan** - 生成删除类型变更方案
   - 使用删除模板
   - 按规则映射字段

7. **_generate_modify_change_plan** - 生成修改类型变更方案
   - 使用修改模板
   - 列名与需求列表一一对应

8. **_generate_import_change_plan** - 生成导入类型变更方案
   - 使用导入模板
   - 列名与需求列表一一对应

9. **_generate_modify_rollback_plan** - 生成修改类型回退方案
   - 使用修改模板
   - 老指标和新指标互换

### 前端实现

#### 组件位置
```
ucm_frontend/src/pages/requirements/RequirementList.tsx
```

#### 核心函数

1. **handleExportChangePlan** - 导出处理函数
   - 调用后端API
   - 处理ZIP文件下载
   - 错误处理

2. **按钮渲染**
   - 位置：在"导出需求"按钮右侧
   - 条件：必须先选择日期

#### 使用示例
```typescript
<Button
  icon={<ExportOutlined />}
  onClick={handleExportChangePlan}
  disabled={!selectedDate}
>
  导出变更方案
</Button>
```

## 使用流程

1. 登录系统
2. 进入需求列表页
3. 选择UCM变更日期（必须选择）
4. 点击"导出变更方案"按钮
5. 系统自动处理并下载ZIP文件
6. 解压ZIP文件查看生成的Excel文件

## 注意事项

1. **必须选择日期**：未选择日期时，"导出变更方案"按钮不可用
2. **数据为空**：如果选中日期没有需求数据，系统会提示"该日期没有需求数据"
3. **文件大小**：大量数据时，生成的ZIP文件可能较大
4. **兼容性**：生成的Excel文件为.xls格式，兼容所有版本Excel
5. **模板配置**：确保模板配置管理中已配置好导入、修改、删除模板

## 技术依赖

### 后端依赖
- Django REST Framework
- openpyxl（Excel文件生成）
- Python标准库：zipfile、io

### 前端依赖
- React
- Ant Design
- axios（API调用）

## 开发日志

### 2026-01-29
- ✅ 实现地点识别功能
- ✅ 实现数据分组功能
- ✅ 实现Excel文件生成功能
- ✅ 实现ZIP打包功能
- ✅ 前端UI实现
- ✅ 功能测试通过

### 已修复问题
1. openpyxl表头样式设置错误
2. 垂直对齐参数错误

## 联系方式

如有问题或建议，请联系开发团队。